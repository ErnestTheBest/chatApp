!function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=9)}([function(e,t,n){"use strict";n.d(t,"a",function(){return o}),n.d(t,"b",function(){return r}),n.d(t,"d",function(){return a}),n.d(t,"c",function(){return i});var o="https://ernestthebest.herokuapp.com/users/".concat(window.sessionStorage.userId,"/chats"),r="https://ernestthebest.herokuapp.com/users/".concat(window.sessionStorage.userId,"/contacts"),a="https://ernestthebest.herokuapp.com/ping",i="https://ernestthebest.herokuapp.com"},function(e,t,n){"use strict";n.d(t,"c",function(){return r}),n.d(t,"b",function(){return a}),n.d(t,"a",function(){return i});var o=n(3);function r(e,t){e.className="status",e.classList.add("status-".concat(Object(o.a)(t)))}function a(e){var t=e.querySelectorAll("input"),n=e.querySelectorAll("button");t.forEach(function(e){return e.removeAttribute("disabled")}),n.forEach(function(e){return e.removeAttribute("disabled")})}function i(e){var t=e.querySelectorAll("input"),n=e.querySelectorAll("button");t.forEach(function(e){e.disabled=!0}),n.forEach(function(e){e.disabled=!0})}},function(e,t,n){"use strict";function o(){var e=window.location.pathname;window.sessionStorage.getItem("userId")?(e.includes("/index.html")||e.includes("/register.html"))&&window.location.replace("./chat.html"):e.includes("/index.html")||e.includes("/register.html")||window.location.replace("./index.html")}function r(){window.sessionStorage.removeItem("userId"),window.sessionStorage.removeItem("credentials"),window.sessionStorage.removeItem("chatContextId"),window.sessionStorage.removeItem("chatUpdates"),window.sessionStorage.removeItem("chatContextName"),window.sessionStorage.removeItem("userStatuses"),o()}function a(e,t,n){window.sessionStorage.setItem("userId",e),window.sessionStorage.setItem("credentials",window.btoa("".concat(t,":").concat(n)))}function i(e,t){window.sessionStorage.setItem("chatContextId",e),window.sessionStorage.setItem("chatContextName",t)}function c(e){window.sessionStorage.setItem("userStatuses",e)}n.d(t,"a",function(){return o}),n.d(t,"b",function(){return r}),n.d(t,"e",function(){return a}),n.d(t,"c",function(){return i}),n.d(t,"d",function(){return c})},function(e,t,n){"use strict";function o(e){var t=new Date,n=[],o=!0,r=!1,a=void 0;try{for(var i,c=e[Symbol.iterator]();!(o=(i=c.next()).done);o=!0){var s=i.value;if(s.seen_at){var u=t-new Date(s.seen_at);u<18e4?n.push([s.id,"online"]):u<36e4?n.push([s.id,"away"]):n.push([s.id,"offline"])}else n.push([s.id,"offline"])}}catch(e){r=!0,a=e}finally{try{o||null==c.return||c.return()}finally{if(r)throw a}}return n}function r(e){var t=JSON.parse(window.sessionStorage.userStatuses),n=!0,o=!1,r=void 0;try{for(var a,i=t[Symbol.iterator]();!(n=(a=i.next()).done);n=!0){var c=a.value;if(e==c[0])return c[1]}}catch(e){o=!0,r=e}finally{try{n||null==i.return||i.return()}finally{if(o)throw r}}}n.d(t,"b",function(){return o}),n.d(t,"a",function(){return r})},function(e,t,n){"use strict";n.d(t,"a",function(){return r}),n.d(t,"d",function(){return a}),n.d(t,"e",function(){return i}),n.d(t,"c",function(){return c}),n.d(t,"b",function(){return s});var o=n(0);function r(){return window.fetch("".concat(o.c,"/users"),{headers:{Authorization:"Basic ".concat(window.sessionStorage.credentials)}}).then(function(e){return e.json()})}function a(e,t){return window.fetch("".concat(o.c,"/users"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:t})}).then(function(e){return e.json()})}function i(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return window.fetch("".concat(o.c,"/users/").concat(window.sessionStorage.userId),{method:"PUT",headers:{Authorization:"Basic ".concat(window.sessionStorage.credentials),"Content-Type":"application/json"},body:JSON.stringify({name:e,password:t})}).then(function(e){return e.ok})}function c(e,t){return window.fetch("".concat(o.c,"/me"),{headers:{Authorization:"Basic ".concat(window.btoa("".concat(e,":").concat(t)))}}).then(function(e){return e.json()})}function s(){return window.fetch("".concat(o.c,"/me"),{headers:{Authorization:"Basic ".concat(window.sessionStorage.credentials)}}).then(function(e){return console.log(e),e.json()})}},,,,,function(e,t,n){"use strict";n.r(t);var o=n(2),r=n(1);function a(){var e=document.querySelector(".context-window span");window.sessionStorage.chatContextId?(e.textContent=window.sessionStorage.chatContextName,i()):(e.textContent="Welcome to chatApp!",e.className="")}function i(){var e=document.querySelector(".context-window span");window.sessionStorage.chatContextId&&Object(r.c)(e,window.sessionStorage.chatContextId)}var c=n(3);function s(){return window.fetch("https://ernestthebest.herokuapp.com/users/".concat(window.sessionStorage.userId,"/contacts/").concat(window.sessionStorage.chatContextId,"/messages"),{headers:{Authorization:"Basic ".concat(window.sessionStorage.credentials)}}).then(function(e){return e.json()})}var u=n(0);var d=document.querySelector(".content-window");function l(e){var t=document.createElement("div"),n=e.sender_id==window.sessionStorage.userId,o=n?"online":Object(c.a)(e.sender_id),r=new Date(e.created_at);n?t.classList.add("outgoing"):t.classList.add("incoming");var a=document.createElement("div");a.classList.add("message-info");var i=document.createElement("span");i.textContent=n?"You, ":window.sessionStorage.chatContextName+", ",i.classList.add("status","status-".concat(o));var s=document.createElement("time");s.dateTime=e.created_at,s.textContent=function(e){var t=e.getHours(),n=e.getMinutes(),o=e.getSeconds();t<10&&(t="0".concat(t));n<10&&(n="0".concat(n));o<10&&(o="0".concat(o));return"".concat(t,":").concat(n,":").concat(o)}(r),a.appendChild(i),a.appendChild(s);var u=document.createElement("div");return u.classList.add("message"),u.textContent=e.message,t.appendChild(a),t.appendChild(u),t}function f(){h(),s().then(function(e){if(e.data.length){for(var t=e.data.length-1;t>=0;t--)d.appendChild(l(e.data[t]));d.scrollTop=d.scrollHeight}})}function h(){for(;d.firstChild;)d.removeChild(d.firstChild)}function w(){return window.fetch(u.a,{headers:{Authorization:"Basic ".concat(window.sessionStorage.credentials)}}).then(function(e){return e.json()})}var m=n(4);function g(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],o=!0,r=!1,a=void 0;try{for(var i,c=e[Symbol.iterator]();!(o=(i=c.next()).done)&&(n.push(i.value),!t||n.length!==t);o=!0);}catch(e){r=!0,a=e}finally{try{o||null==c.return||c.return()}finally{if(r)throw a}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var v={};w().then(function(e){var t=e.data;console.log(t),t.filter(function(e){return null!==e.created_at}).forEach(function(e){v[e.user_id]=+new Date(e.created_at)})});var p={pingPongService:!1,userStatusService:!1,userStatusUpdateService:!1,messagesUpdateService:!1,newMessagesUpdateService:!1},S=!1;function y(){return p.pingPongService||(p.pingPongService=!0),window.fetch(u.d,{method:"POST",headers:{Authorization:"Basic ".concat(window.sessionStorage.credentials)}}).then(function(){setTimeout(y,1e4)})}function b(){S||(S=!0,C())}function C(){return p.messagesUpdateService||(p.messagesUpdateService=!0),s().then(function(e){try{if(e.data.length){var t=document.querySelector(".content-window").lastChild.querySelector("time").dateTime;e.data[0].created_at!=t&&f()}}catch(e){console.log("Something went wrong in messageUpdateService")}setTimeout(C,3e3)})}function I(){return p.userStatusService||(p.userStatusService=!0),Object(m.a)().then(function(e){Object(o.d)(JSON.stringify(Object(c.b)(e.data))),setTimeout(I,1e4)})}function x(){var e;p.userStatusUpdateService||(p.userStatusUpdateService=!0),q.querySelectorAll("li").forEach(function(e){Object(r.c)(e.querySelector("span"),e.getAttribute("data-id"))}),i(),(e=d.querySelectorAll(".incoming span")).length&&e.forEach(function(e){Object(r.c)(e,window.sessionStorage.chatContextId)}),setTimeout(x,1e4)}function j(){var e;p.newMessagesUpdateService||(p.newMessagesUpdateService=!0),e={},document.querySelectorAll(".contacts-list li").forEach(function(t){e[t.getAttribute("data-id")]=Date.now()}),w().then(function(t){var n=t.data,o={};n.filter(function(e){return null!==e.created_at}).forEach(function(e){o[+e.user_id]=+new Date(e.created_at)});var r=[],a=[];Object.entries(o).forEach(function(t){var n=g(t,2),o=n[0],i=n[1];!v.hasOwnProperty(o)||v["".concat(o)]<i&&!e.hasOwnProperty(o)?(r.push(parseInt(o)),a.push(parseInt(o))):v["".concat(o)]<i&&r.push(parseInt(o))}),a.length?Object(m.a)().then(function(e){e.data.forEach(function(e){a.includes(e.id)&&A(e.id,e.username,e.name)}),N(r)}):N(r),v=o}),setTimeout(j,3e3)}function O(){var e=document.querySelector(".message-window");window.sessionStorage.chatContextId?(e.classList.remove("hidden"),"offline"===Object(c.a)(window.sessionStorage.chatContextId)?Object(r.a)(e):Object(r.b)(e)):e.classList.add("hidden")}function E(){var e,t=document.querySelector(".message-window input");t.value&&((e=t.value,window.fetch("https://ernestthebest.herokuapp.com/users/".concat(window.sessionStorage.userId,"/contacts/").concat(window.sessionStorage.chatContextId,"/messages"),{method:"POST",headers:{Authorization:"Basic ".concat(window.sessionStorage.credentials),"Content-Type":"application/json"},body:JSON.stringify({message:e})}).then(function(e){return e.json()})).then(f),t.value="",C())}document.querySelector(".message-window input").addEventListener("keypress",function(e){13===e.charCode&&E()}),document.querySelector(".message-window .message-button").addEventListener("click",function(e){e.preventDefault(),E()});var q=document.querySelector(".contacts-list");function A(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0,o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(window.sessionStorage.userId!=e){var r=document.createElement("li"),a=document.createElement("span");a.classList.add("status","status-".concat(Object(c.a)(e))),a.textContent=n||t;var i=document.createElement("i");i.classList.add("material-icons","w3-large"),o?(i.title="Remove favorite",i.textContent="person_add_disabled",i.addEventListener("click",function(){var e;e=i.parentNode.getAttribute("data-id"),window.fetch(u.b+"/"+e,{method:"DELETE",headers:{Authorization:"Basic ".concat(window.sessionStorage.credentials)}}),setTimeout(_,500)})):(i.title="Add favorite",i.textContent="person_add",i.addEventListener("click",function(){var e;e=i.parentNode.getAttribute("data-id"),window.fetch(u.b,{method:"POST",headers:{Authorization:"Basic ".concat(window.sessionStorage.credentials),"Content-Type":"application/json"},body:JSON.stringify({id:parseInt(e)})}),setTimeout(_,500)})),r.setAttribute("data-id",e),r.appendChild(a),r.appendChild(i),r.addEventListener("click",T),q.appendChild(r)}}function L(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return function(){for(;q.firstChild;)q.removeChild(q.firstChild)}(),new Promise(function(n,o){var r=!0,a=!1,i=void 0;try{for(var c,s=e[Symbol.iterator]();!(r=(c=s.next()).done);r=!0){var u=c.value;A(u.id,u.username,u.name,t)}}catch(e){a=!0,i=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw i}}n()})}function T(e){if("I"!==e.target.nodeName){e="SPAN"===e.target.nodeName?e.target.parentNode:e.target;var t,n=q.querySelector(".active-contact");if(n){if(e===n)return;e.classList.toggle("active-contact"),n.classList.toggle("active-contact")}else e.classList.toggle("active-contact");Object(o.c)(e.getAttribute("data-id"),e.querySelector("span").innerText),a(),O(),f(),(t=e.querySelector(".new-message"))&&t.remove(),b(),document.querySelector(".menu-button").classList.remove("toggle"),document.querySelector(".container").classList.remove("menu-open"),document.querySelector(".search-input input").value="",_()}}function _(){window.fetch(u.b,{headers:{Authorization:"Basic ".concat(window.sessionStorage.credentials)}}).then(function(e){return e.json()}).then(function(e){return e.data.length?L(e.data,!0):Object(m.a)().then(function(e){return L(e.data)})}).then(function(){if(window.sessionStorage.chatContextId){var e=document.querySelector('[data-id="'.concat(window.sessionStorage.chatContextId,'"]'));console.log(e),e.classList.add("active-contact")}})}function N(e){var t=!0,n=!1,o=void 0;try{for(var r,a=e[Symbol.iterator]();!(t=(r=a.next()).done);t=!0){var i=r.value,c=document.querySelector('[data-id="'.concat(i,'"]')),s=c.querySelector(".new-message");if(!c.classList.contains("active-contact")&&!s){var u=document.createElement("span");u.className="new-message",c.querySelector("span").appendChild(u)}}}catch(e){n=!0,o=e}finally{try{t||null==a.return||a.return()}finally{if(n)throw o}}}Object(o.a)(),document.querySelector(".menu-button").addEventListener("click",function(){document.querySelector(".menu-button").classList.toggle("toggle"),document.querySelector(".container").classList.toggle("menu-open")}),document.getElementById("logout").addEventListener("click",o.b),I(),_(),a(),h(),O(),y(),setTimeout(x,3e3),setTimeout(j,3e3),window.sessionStorage.chatContextId&&(f(),b())}]);